"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
// @ts-ignore
var root_1 = require("react-hot-loader/root");
var react_1 = __importDefault(require("react"));
var react_dom_1 = __importDefault(require("react-dom"));
var logTrace_1 = require("../helpers/logTrace");
var insight_1 = require("./insight");
var i18n_1 = require("./i18n");
var create_history_1 = require("./history/create-history");
var history_context_1 = require("./history/history-context");
var beforeDestroy_1 = require("./beforeDestroy");
var _bridge_1 = require("../bridge/_bridge");
var configprovider_1 = require("@tencent/tea-component/lib/configprovider");
var pageManager = _bridge_1._bridge("nmc/main/pagemanager");
var errorBoundaryEvent = insight_1.internalInsightShouldNotUsedByBusiness
    ? insight_1.internalInsightShouldNotUsedByBusiness.register("react-error-boundary", {
        level: insight_1.internalInsightShouldNotUsedByBusiness.EventLevel.Error,
    })
    : [];
// 入口组件
function createEntry(controller, action, entry, setBeforeDestroyListener) {
    var i18n = i18n_1.getI18NInstance();
    var EntryContent = typeof entry === "function" ? entry : entry.component || entry.render;
    EntryContent["displayName"] = "Entry(" + controller + "/" + action + ")";
    var confirmation = null;
    var history = create_history_1.createHistory({
        controller: controller,
        action: action,
        getUserConfirmation: function (message, callback) {
            if (!confirmation) {
                callback(window.confirm(message));
            }
            else {
                confirmation(message, callback);
            }
        },
    });
    return root_1.hot(function TeaEntry() {
        var classPrefix = typeof TEA_CLASS_PREFIX !== "undefined" ? TEA_CLASS_PREFIX : undefined;
        var locale = typeof WEBPACK_BUILD_LOCALE !== "undefined"
            ? WEBPACK_BUILD_LOCALE
            : i18n.language;
        return (react_1.default.createElement(ErrorBoundary, null,
            react_1.default.createElement(i18n_1.I18NProvider, { i18n: i18n },
                react_1.default.createElement(configprovider_1.ConfigProvider, { locale: locale, classPrefix: classPrefix },
                    react_1.default.createElement(history_context_1.HistoryContext.Provider, { value: {
                            history: history,
                            setConfirmation: function (current) { return (confirmation = current); },
                        } },
                        react_1.default.createElement(beforeDestroy_1.BeforeDestroyContext.Provider, { value: {
                                setBeforeDestroyListener: setBeforeDestroyListener,
                            } },
                            react_1.default.createElement(EntryContent, null)))))));
    });
}
var ErrorBoundary = /** @class */ (function (_super) {
    __extends(ErrorBoundary, _super);
    function ErrorBoundary(props) {
        var _this = _super.call(this, props) || this;
        _this.state = { hasError: false };
        return _this;
    }
    ErrorBoundary.getDerivedStateFromError = function (error) {
        return { hasError: true };
    };
    ErrorBoundary.prototype.componentDidCatch = function (error, errorInfo) {
        console.warn(errorInfo);
        pageManager.renderOops("react-error-boundary");
        var message = error.message, stack = error.stack;
        errorBoundaryEvent.push(__assign({}, errorInfo, { message: message || errorInfo.description, stack: stack }));
    };
    ErrorBoundary.prototype.render = function () {
        if (this.state.hasError) {
            return null;
        }
        return this.props.children;
    };
    return ErrorBoundary;
}(react_1.default.Component));
/**
 * 为模块生成渲染和销毁方法
 */
exports.factory = function (controller, action, entry) { return function () {
    // 模块需要实现渲染和销毁两个方法
    var render, destroy;
    // 渲染 DOM，render() 时创建，destory() 时回收
    var container;
    // 模块标识，同时用作 container 的 id
    var moduleKey = controller + "-" + action;
    var currentBeforeListener = null;
    var beforeDestroy = function (beforeDestroyParams) {
        if (typeof currentBeforeListener === "function") {
            return currentBeforeListener(beforeDestroyParams);
        }
    };
    var setBeforeDestroyListener = function (listener) {
        currentBeforeListener = listener;
    };
    // 渲染：路由命中时渲染
    render = function () {
        if (entry === 404) {
            return 404;
        }
        // window.nmc.render 负责把 DOM 创建并放在 #app-area 中，这个 DOM 后续被渲染所用
        window.nmc.render("<div id=\"" + moduleKey + "\" class=\"tea-page-root\"></div>", 
        // 总览 home 特殊处理
        controller === "home" ? "" : controller);
        container = document.querySelector("#" + moduleKey);
        if (container) {
            var Entry = createEntry(controller, action, entry, setBeforeDestroyListener);
            react_dom_1.default.render(react_1.default.createElement(Entry, null), container);
        }
    };
    // 模块：路由切走时销毁
    destroy = function () {
        if (container) {
            react_dom_1.default.unmountComponentAtNode(container);
        }
        container = null;
    };
    return __assign({}, insightFactory(moduleKey, render, destroy, beforeDestroy), { 
        // 导出文档标题（如果已定义）
        title: typeof entry === "object" ? entry.title : null });
}; };
function insightFactory(moduleKey, render, destroy, beforeDestroy) {
    var _a = insight_1.internalInsightShouldNotUsedByBusiness || {}, care = _a.care, register = _a.register, EventLevel = _a.EventLevel;
    function wrapFn(fn, moduleError, message) {
        return care(fn, {
            capture: function (trace) {
                var logMessage = "\u6A21\u5757 " + moduleKey + " " + message + "\uFF1A" + trace.message;
                logTrace_1.logTrace(logMessage, trace);
                moduleError.push({
                    message: logMessage,
                    moduleKey: moduleKey,
                    stack: trace.stack,
                });
                throw trace;
            },
        });
    }
    if (typeof care === "function") {
        // 监控：模块渲染异常
        var moduleRenderError = register("module-render-error", {
            level: EventLevel.Error,
        });
        // 监控：模块销毁异常
        var moduleDestroyError = register("module-destroy-error", {
            level: EventLevel.Error,
        });
        // 监控：beforeDestroy 异常
        var moduleBeforeDestroyError = register("module-before-destroy-error", {
            level: EventLevel.Error,
        });
        // 捕获渲染异常
        render = wrapFn(render, moduleRenderError, "渲染异常");
        // 捕获销毁异常
        destroy = wrapFn(destroy, moduleDestroyError, "销毁异常");
        // 捕获 beforeDestroy 钩子异常
        beforeDestroy = wrapFn(beforeDestroy, moduleBeforeDestroyError, "before Destroy 异常");
    }
    return { render: render, destroy: destroy, beforeDestroy: beforeDestroy };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50cnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29yZS9lbnRyeS50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxhQUFhO0FBQ2IsOENBQXdEO0FBRXhELGdEQUEwQjtBQUMxQix3REFBaUM7QUFFakMsZ0RBQStDO0FBQy9DLHFDQUdtQjtBQUNuQiwrQkFBdUQ7QUFDdkQsMkRBQXlEO0FBQ3pELDZEQUF5RTtBQUN6RSxpREFJeUI7QUFDekIsNkNBQTRDO0FBQzVDLDRFQUEyRTtBQUUzRSxJQUFNLFdBQVcsR0FBRyxpQkFBTyxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFDcEQsSUFBTSxrQkFBa0IsR0FBRyxnREFBUTtJQUNqQyxDQUFDLENBQUMsZ0RBQVEsQ0FBQyxRQUFRLENBQUMsc0JBQXNCLEVBQUU7UUFDeEMsS0FBSyxFQUFFLGdEQUFRLENBQUMsVUFBVSxDQUFDLEtBQUs7S0FDakMsQ0FBQztJQUNKLENBQUMsQ0FBQyxFQUFFLENBQUM7QUFFUCxPQUFPO0FBQ1AsU0FBUyxXQUFXLENBQ2xCLFVBQWtCLEVBQ2xCLE1BQWMsRUFDZCxLQUE2QixFQUM3Qix3QkFBbUU7SUFFbkUsSUFBTSxJQUFJLEdBQUcsc0JBQWUsRUFBRSxDQUFDO0lBRS9CLElBQU0sWUFBWSxHQUNoQixPQUFPLEtBQUssS0FBSyxVQUFVLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFNBQVMsSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDO0lBQ3hFLFlBQVksQ0FBQyxhQUFhLENBQUMsR0FBRyxXQUFTLFVBQVUsU0FBSSxNQUFNLE1BQUcsQ0FBQztJQUUvRCxJQUFJLFlBQVksR0FBaUIsSUFBSSxDQUFDO0lBQ3RDLElBQU0sT0FBTyxHQUFHLDhCQUFhLENBQUM7UUFDNUIsVUFBVSxZQUFBO1FBQ1YsTUFBTSxRQUFBO1FBQ04sbUJBQW1CLEVBQUUsVUFBQyxP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QVM7UUFDVCxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUNuRCxTQUFTO1FBQ1QsT0FBTyxHQUFHLE1BQU0sQ0FBQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDdEQsd0JBQXdCO1FBQ3hCLGFBQWEsR0FBRyxNQUFNLENBQ3BCLGFBQWEsRUFDYix3QkFBd0IsRUFDeEIsbUJBQW1CLENBQ3BCLENBQUM7S0FDSDtJQUNELE9BQU8sRUFBRSxNQUFNLFFBQUEsRUFBRSxPQUFPLFNBQUEsRUFBRSxhQUFhLGVBQUEsRUFBRSxDQUFDO0FBQzVDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAdHMtaWdub3JlXG5pbXBvcnQgeyBob3QgYXMgUmVhY3RIb3QgfSBmcm9tIFwicmVhY3QtaG90LWxvYWRlci9yb290XCI7XG5cbmltcG9ydCBSZWFjdCBmcm9tIFwicmVhY3RcIjtcbmltcG9ydCBSZWFjdERPTSBmcm9tIFwicmVhY3QtZG9tXCI7XG5cbmltcG9ydCB7IGxvZ1RyYWNlIH0gZnJvbSBcIi4uL2hlbHBlcnMvbG9nVHJhY2VcIjtcbmltcG9ydCB7XG4gIGludGVybmFsSW5zaWdodFNob3VsZE5vdFVzZWRCeUJ1c2luZXNzIGFzIF9pbnNpZ2h0LFxuICBJbnNpZ2h0Q29yZSxcbn0gZnJvbSBcIi4vaW5zaWdodFwiO1xuaW1wb3J0IHsgSTE4TlByb3ZpZGVyLCBnZXRJMThOSW5zdGFuY2UgfSBmcm9tIFwiLi9pMThuXCI7XG5pbXBvcnQgeyBjcmVhdGVIaXN0b3J5IH0gZnJvbSBcIi4vaGlzdG9yeS9jcmVhdGUtaGlzdG9yeVwiO1xuaW1wb3J0IHsgQ29uZmlybWF0aW9uLCBIaXN0b3J5Q29udGV4dCB9IGZyb20gXCIuL2hpc3RvcnkvaGlzdG9yeS1jb250ZXh0XCI7XG5pbXBvcnQge1xuICBCZWZvcmVEZXN0cm95Q29udGV4dCxcbiAgQmVmb3JlRGVzdHJveUxpc3RlbmVyLFxuICBCZWZvcmVEZXN0cm95UGFyYW1zLFxufSBmcm9tIFwiLi9iZWZvcmVEZXN0cm95XCI7XG5pbXBvcnQgeyBfYnJpZGdlIH0gZnJvbSBcIi4uL2JyaWRnZS9fYnJpZGdlXCI7XG5pbXBvcnQgeyBDb25maWdQcm92aWRlciB9IGZyb20gXCJAdGVuY2VudC90ZWEtY29tcG9uZW50L2xpYi9jb25maWdwcm92aWRlclwiO1xuXG5jb25zdCBwYWdlTWFuYWdlciA9IF9icmlkZ2UoXCJubWMvbWFpbi9wYWdlbWFuYWdlclwiKTtcbmNvbnN0IGVycm9yQm91bmRhcnlFdmVudCA9IF9pbnNpZ2h0XG4gID8gX2luc2lnaHQucmVnaXN0ZXIoXCJyZWFjdC1lcnJvci1ib3VuZGFyeVwiLCB7XG4gICAgICBsZXZlbDogX2luc2lnaHQuRXZlbnRMZXZlbC5FcnJvcixcbiAgICB9KVxuICA6IFtdO1xuXG4vLyDlhaXlj6Pnu4Tku7ZcbmZ1bmN0aW9uIGNyZWF0ZUVudHJ5KFxuICBjb250cm9sbGVyOiBzdHJpbmcsXG4gIGFjdGlvbjogc3RyaW5nLFxuICBlbnRyeTogRXhjbHVkZTxBcHBFbnRyeSwgNDA0PixcbiAgc2V0QmVmb3JlRGVzdHJveUxpc3RlbmVyOiAobGlzdGVuZXI6IEJlZm9yZURlc3Ryb3lMaXN0ZW5lcikgPT4gdm9pZFxuKSB7XG4gIGNvbnN0IGkxOG4gPSBnZXRJMThOSW5zdGFuY2UoKTtcblxuICBjb25zdCBFbnRyeUNvbnRlbnQgPVxuICAgIHR5cGVvZiBlbnRyeSA9PT0gXCJmdW5jdGlvblwiID8gZW50cnkgOiBlbnRyeS5jb21wb25lbnQgfHwgZW50cnkucmVuZGVyO1xuICBFbnRyeUNvbnRlbnRbXCJkaXNwbGF5TmFtZVwiXSA9IGBFbnRyeSgke2NvbnRyb2xsZXJ9LyR7YWN0aW9ufSlgO1xuXG4gIGxldCBjb25maXJtYXRpb246IENvbmZpcm1hdGlvbiA9IG51bGw7XG4gIGNvbnN0IGhpc3RvcnkgPSBjcmVhdGVIaXN0b3J5KHtcbiAgICBjb250cm9sbGVyLFxuICAgIGFjdGlvbixcbiAgICBnZXRVc2VyQ29uZmlybWF0aW9uOiAobWVzc2FnZSwgY2FsbGJhY2spID0+IHtcbiAgICAgIGlmICghY29uZmlybWF0aW9uKSB7XG4gICAgICAgIGNhbGxiYWNrKHdpbmRvdy5jb25maXJtKG1lc3NhZ2UpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbmZpcm1hdGlvbihtZXNzYWdlLCBjYWxsYmFjayk7XG4gICAgICB9XG4gICAgfSxcbiAgfSk7XG5cbiAgcmV0dXJuIFJlYWN0SG90KGZ1bmN0aW9uIFRlYUVudHJ5KCkge1xuICAgIGNvbnN0IGNsYXNzUHJlZml4ID1cbiAgICAgIHR5cGVvZiBURUFfQ0xBU1NfUFJFRklYICE9PSBcInVuZGVmaW5lZFwiID8gVEVBX0NMQVNTX1BSRUZJWCA6IHVuZGVmaW5lZDtcbiAgICBjb25zdCBsb2NhbGUgPVxuICAgICAgdHlwZW9mIFdFQlBBQ0tfQlVJTERfTE9DQUxFICE9PSBcInVuZGVmaW5lZFwiXG4gICAgICAgID8gV0VCUEFDS19CVUlMRF9MT0NBTEVcbiAgICAgICAgOiBpMThuLmxhbmd1YWdlO1xuICAgIHJldHVybiAoXG4gICAgICA8RXJyb3JCb3VuZGFyeT5cbiAgICAgICAgPEkxOE5Qcm92aWRlciBpMThuPXtpMThufT5cbiAgICAgICAgICA8Q29uZmlnUHJvdmlkZXIgbG9jYWxlPXtsb2NhbGUgYXMgYW55fSBjbGFzc1ByZWZpeD17Y2xhc3NQcmVmaXh9PlxuICAgICAgICAgICAgPEhpc3RvcnlDb250ZXh0LlByb3ZpZGVyXG4gICAgICAgICAgICAgIHZhbHVlPXt7XG4gICAgICAgICAgICAgICAgaGlzdG9yeSxcbiAgICAgICAgICAgICAgICBzZXRDb25maXJtYXRpb246IGN1cnJlbnQgPT4gKGNvbmZpcm1hdGlvbiA9IGN1cnJlbnQpLFxuICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICA8QmVmb3JlRGVzdHJveUNvbnRleHQuUHJvdmlkZXJcbiAgICAgICAgICAgICAgICB2YWx1ZT17e1xuICAgICAgICAgICAgICAgICAgc2V0QmVmb3JlRGVzdHJveUxpc3RlbmVyLFxuICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICA8RW50cnlDb250ZW50IC8+XG4gICAgICAgICAgICAgIDwvQmVmb3JlRGVzdHJveUNvbnRleHQuUHJvdmlkZXI+XG4gICAgICAgICAgICA8L0hpc3RvcnlDb250ZXh0LlByb3ZpZGVyPlxuICAgICAgICAgIDwvQ29uZmlnUHJvdmlkZXI+XG4gICAgICAgIDwvSTE4TlByb3ZpZGVyPlxuICAgICAgPC9FcnJvckJvdW5kYXJ5PlxuICAgICk7XG4gIH0pO1xufVxuXG5jbGFzcyBFcnJvckJvdW5kYXJ5IGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PHt9LCB7IGhhc0Vycm9yOiBib29sZWFuIH0+IHtcbiAgY29uc3RydWN0b3IocHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcyk7XG4gICAgdGhpcy5zdGF0ZSA9IHsgaGFzRXJyb3I6IGZhbHNlIH07XG4gIH1cblxuICBzdGF0aWMgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yKGVycm9yKSB7XG4gICAgcmV0dXJuIHsgaGFzRXJyb3I6IHRydWUgfTtcbiAgfVxuXG4gIGNvbXBvbmVudERpZENhdGNoKGVycm9yLCBlcnJvckluZm8pIHtcbiAgICBjb25zb2xlLndhcm4oZXJyb3JJbmZvKTtcbiAgICBwYWdlTWFuYWdlci5yZW5kZXJPb3BzKFwicmVhY3QtZXJyb3ItYm91bmRhcnlcIik7XG4gICAgY29uc3QgeyBtZXNzYWdlLCBzdGFjayB9ID0gZXJyb3I7XG4gICAgZXJyb3JCb3VuZGFyeUV2ZW50LnB1c2goe1xuICAgICAgLi4uZXJyb3JJbmZvLFxuICAgICAgbWVzc2FnZTogbWVzc2FnZSB8fCBlcnJvckluZm8uZGVzY3JpcHRpb24sXG4gICAgICBzdGFjayxcbiAgICB9KTtcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBpZiAodGhpcy5zdGF0ZS5oYXNFcnJvcikge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnByb3BzLmNoaWxkcmVuO1xuICB9XG59XG5cbi8qKlxuICog5Li65qih5Z2X55Sf5oiQ5riy5p+T5ZKM6ZSA5q+B5pa55rOVXG4gKi9cbmV4cG9ydCBjb25zdCBmYWN0b3J5OiBFbnRyeU1vZHVsZUZhY3RvcnkgPSAoXG4gIGNvbnRyb2xsZXIsXG4gIGFjdGlvbixcbiAgZW50cnlcbikgPT4gKCkgPT4ge1xuICAvLyDmqKHlnZfpnIDopoHlrp7njrDmuLLmn5PlkozplIDmr4HkuKTkuKrmlrnms5VcbiAgbGV0IHJlbmRlcjogKCkgPT4gdm9pZCwgZGVzdHJveTogKCkgPT4gdm9pZDtcblxuICAvLyDmuLLmn5MgRE9N77yMcmVuZGVyKCkg5pe25Yib5bu677yMZGVzdG9yeSgpIOaXtuWbnuaUtlxuICBsZXQgY29udGFpbmVyOiBIVE1MRGl2RWxlbWVudDtcblxuICAvLyDmqKHlnZfmoIfor4bvvIzlkIzml7bnlKjkvZwgY29udGFpbmVyIOeahCBpZFxuICBjb25zdCBtb2R1bGVLZXkgPSBgJHtjb250cm9sbGVyfS0ke2FjdGlvbn1gO1xuXG4gIGxldCBjdXJyZW50QmVmb3JlTGlzdGVuZXI6IEJlZm9yZURlc3Ryb3lMaXN0ZW5lciA9IG51bGw7XG5cbiAgY29uc3QgYmVmb3JlRGVzdHJveSA9IChiZWZvcmVEZXN0cm95UGFyYW1zOiBCZWZvcmVEZXN0cm95UGFyYW1zKSA9PiB7XG4gICAgaWYgKHR5cGVvZiBjdXJyZW50QmVmb3JlTGlzdGVuZXIgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgcmV0dXJuIGN1cnJlbnRCZWZvcmVMaXN0ZW5lcihiZWZvcmVEZXN0cm95UGFyYW1zKTtcbiAgICB9XG4gIH07XG5cbiAgY29uc3Qgc2V0QmVmb3JlRGVzdHJveUxpc3RlbmVyID0gKGxpc3RlbmVyOiBCZWZvcmVEZXN0cm95TGlzdGVuZXIpID0+IHtcbiAgICBjdXJyZW50QmVmb3JlTGlzdGVuZXIgPSBsaXN0ZW5lcjtcbiAgfTtcblxuICAvLyDmuLLmn5PvvJrot6/nlLHlkb3kuK3ml7bmuLLmn5NcbiAgcmVuZGVyID0gKCkgPT4ge1xuICAgIGlmIChlbnRyeSA9PT0gNDA0KSB7XG4gICAgICByZXR1cm4gNDA0O1xuICAgIH1cbiAgICAvLyB3aW5kb3cubm1jLnJlbmRlciDotJ/otKPmioogRE9NIOWIm+W7uuW5tuaUvuWcqCAjYXBwLWFyZWEg5Lit77yM6L+Z5LiqIERPTSDlkI7nu63ooqvmuLLmn5PmiYDnlKhcbiAgICB3aW5kb3cubm1jLnJlbmRlcihcbiAgICAgIGA8ZGl2IGlkPVwiJHttb2R1bGVLZXl9XCIgY2xhc3M9XCJ0ZWEtcGFnZS1yb290XCI+PC9kaXY+YCxcbiAgICAgIC8vIOaAu+iniCBob21lIOeJueauiuWkhOeQhlxuICAgICAgY29udHJvbGxlciA9PT0gXCJob21lXCIgPyBcIlwiIDogY29udHJvbGxlclxuICAgICk7XG4gICAgY29udGFpbmVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgIyR7bW9kdWxlS2V5fWApO1xuICAgIGlmIChjb250YWluZXIpIHtcbiAgICAgIGNvbnN0IEVudHJ5ID0gY3JlYXRlRW50cnkoXG4gICAgICAgIGNvbnRyb2xsZXIsXG4gICAgICAgIGFjdGlvbixcbiAgICAgICAgZW50cnksXG4gICAgICAgIHNldEJlZm9yZURlc3Ryb3lMaXN0ZW5lclxuICAgICAgKTtcbiAgICAgIFJlYWN0RE9NLnJlbmRlcig8RW50cnkgLz4sIGNvbnRhaW5lcik7XG4gICAgfVxuICB9O1xuXG4gIC8vIOaooeWdl++8mui3r+eUseWIh+i1sOaXtumUgOavgVxuICBkZXN0cm95ID0gKCkgPT4ge1xuICAgIGlmIChjb250YWluZXIpIHtcbiAgICAgIFJlYWN0RE9NLnVubW91bnRDb21wb25lbnRBdE5vZGUoY29udGFpbmVyKTtcbiAgICB9XG4gICAgY29udGFpbmVyID0gbnVsbDtcbiAgfTtcblxuICByZXR1cm4ge1xuICAgIC8vIOWMheijhSByZW5kZXIg5ZKMIGRlc3Ryb3kg5pa55rOV55qE5byC5bi45aSE55CGXG4gICAgLi4uaW5zaWdodEZhY3RvcnkobW9kdWxlS2V5LCByZW5kZXIsIGRlc3Ryb3ksIGJlZm9yZURlc3Ryb3kpLFxuICAgIC8vIOWvvOWHuuaWh+aho+agh+mimO+8iOWmguaenOW3suWumuS5ie+8iVxuICAgIHRpdGxlOiB0eXBlb2YgZW50cnkgPT09IFwib2JqZWN0XCIgPyBlbnRyeS50aXRsZSA6IG51bGwsXG4gIH0gYXMgRW50cnlNb2R1bGU7XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIEVudHJ5TW9kdWxlRmFjdG9yeSB7XG4gIChjb250cm9sbGVyOiBzdHJpbmcsIGFjdGlvbjogc3RyaW5nLCBlbnRyeTogQXBwRW50cnkpOiAoKSA9PiBFbnRyeU1vZHVsZTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBFbnRyeU1vZHVsZSB7XG4gIHJlbmRlcigpOiB2b2lkO1xuICBkZXN0cm95KCk6IHZvaWQ7XG4gIHRpdGxlPzogc3RyaW5nO1xufVxuXG4vKipcbiAqIOWNleS4qui3r+eUseWFpeWPo+WumuS5ie+8jOWMheWQq+a4suafk+aWueazleOAgeiPnOWNleWSjCBDU1Mg5a6a5LmJXG4gKi9cbmV4cG9ydCB0eXBlIEFwcEVudHJ5ID0gUmVhY3QuQ29tcG9uZW50VHlwZTxhbnk+IHwgQXBwRW50cnlEZXRhaWwgfCA0MDQ7XG5cbmV4cG9ydCB0eXBlIEFwcEVudHJ5RGV0YWlsID0ge1xuICAvKipcbiAgICog6Lev55Sx5riy5p+T57uE5Lu2XG4gICAqL1xuICBjb21wb25lbnQ/OiBSZWFjdC5Db21wb25lbnRUeXBlPGFueT47XG5cbiAgLyoqXG4gICAqIOi3r+eUsea4suafk+aWueazle+8jOmcgOi/lOWbnuS4gOS4qiBSZWFjdC5SZWFjdE5vZGVcbiAgICovXG4gIHJlbmRlcj86ICgpID0+IEpTWC5FbGVtZW50O1xuXG4gIC8qKlxuICAgKiDor6Xot6/nlLHkuIvmiYDmnInnmoTmlofmoaPmoIfpophcbiAgICpcbiAgICog5aaC5p6c5biM5pyb5Yqo5oCB6K6+572u5qCH6aKY77yM5Y+v5Lul5L2/55SoIHVzZURvY3VtZW50VGl0bGUoKSAvIHNldERvY3VtZW50VGl0bGUoKVxuICAgKi9cbiAgdGl0bGU/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIOiuvue9ruS4uuaOp+WItuWPsCBjb250cm9sbGVyIOe6p+aooeWdl1xuICAgKi9cbiAgY29udHJvbGxlck1vZGU/OiBib29sZWFuO1xufTtcblxuZnVuY3Rpb24gaW5zaWdodEZhY3RvcnkoXG4gIG1vZHVsZUtleTogc3RyaW5nLFxuICByZW5kZXI6ICgpID0+IHZvaWQsXG4gIGRlc3Ryb3k6ICgpID0+IHZvaWQsXG4gIGJlZm9yZURlc3Ryb3k6IEJlZm9yZURlc3Ryb3lMaXN0ZW5lclxuKSB7XG4gIGNvbnN0IHsgY2FyZSwgcmVnaXN0ZXIsIEV2ZW50TGV2ZWwgfSA9IF9pbnNpZ2h0IHx8ICh7fSBhcyBJbnNpZ2h0Q29yZSk7XG4gIGZ1bmN0aW9uIHdyYXBGbihmbiwgbW9kdWxlRXJyb3IsIG1lc3NhZ2UpIHtcbiAgICByZXR1cm4gY2FyZShmbiwge1xuICAgICAgY2FwdHVyZTogdHJhY2UgPT4ge1xuICAgICAgICBjb25zdCBsb2dNZXNzYWdlID0gYOaooeWdlyAke21vZHVsZUtleX0gJHttZXNzYWdlfe+8miR7dHJhY2UubWVzc2FnZX1gO1xuICAgICAgICBsb2dUcmFjZShsb2dNZXNzYWdlLCB0cmFjZSk7XG4gICAgICAgIG1vZHVsZUVycm9yLnB1c2goe1xuICAgICAgICAgIG1lc3NhZ2U6IGxvZ01lc3NhZ2UsXG4gICAgICAgICAgbW9kdWxlS2V5LFxuICAgICAgICAgIHN0YWNrOiB0cmFjZS5zdGFjayxcbiAgICAgICAgfSk7XG4gICAgICAgIHRocm93IHRyYWNlO1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGlmICh0eXBlb2YgY2FyZSA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgLy8g55uR5o6n77ya5qih5Z2X5riy5p+T5byC5bi4XG4gICAgY29uc3QgbW9kdWxlUmVuZGVyRXJyb3IgPSByZWdpc3RlcihcIm1vZHVsZS1yZW5kZXItZXJyb3JcIiwge1xuICAgICAgbGV2ZWw6IEV2ZW50TGV2ZWwuRXJyb3IsXG4gICAgfSk7XG4gICAgLy8g55uR5o6n77ya5qih5Z2X6ZSA5q+B5byC5bi4XG4gICAgY29uc3QgbW9kdWxlRGVzdHJveUVycm9yID0gcmVnaXN0ZXIoXCJtb2R1bGUtZGVzdHJveS1lcnJvclwiLCB7XG4gICAgICBsZXZlbDogRXZlbnRMZXZlbC5FcnJvcixcbiAgICB9KTtcbiAgICAvLyDnm5HmjqfvvJpiZWZvcmVEZXN0cm95IOW8guW4uFxuICAgIGNvbnN0IG1vZHVsZUJlZm9yZURlc3Ryb3lFcnJvciA9IHJlZ2lzdGVyKFwibW9kdWxlLWJlZm9yZS1kZXN0cm95LWVycm9yXCIsIHtcbiAgICAgIGxldmVsOiBFdmVudExldmVsLkVycm9yLFxuICAgIH0pO1xuICAgIC8vIOaNleiOt+a4suafk+W8guW4uFxuICAgIHJlbmRlciA9IHdyYXBGbihyZW5kZXIsIG1vZHVsZVJlbmRlckVycm9yLCBcIua4suafk+W8guW4uFwiKTtcbiAgICAvLyDmjZXojrfplIDmr4HlvILluLhcbiAgICBkZXN0cm95ID0gd3JhcEZuKGRlc3Ryb3ksIG1vZHVsZURlc3Ryb3lFcnJvciwgXCLplIDmr4HlvILluLhcIik7XG4gICAgLy8g5o2V6I63IGJlZm9yZURlc3Ryb3kg6ZKp5a2Q5byC5bi4XG4gICAgYmVmb3JlRGVzdHJveSA9IHdyYXBGbihcbiAgICAgIGJlZm9yZURlc3Ryb3ksXG4gICAgICBtb2R1bGVCZWZvcmVEZXN0cm95RXJyb3IsXG4gICAgICBcImJlZm9yZSBEZXN0cm95IOW8guW4uFwiXG4gICAgKTtcbiAgfVxuICByZXR1cm4geyByZW5kZXIsIGRlc3Ryb3ksIGJlZm9yZURlc3Ryb3kgfTtcbn1cbiJdfQ==