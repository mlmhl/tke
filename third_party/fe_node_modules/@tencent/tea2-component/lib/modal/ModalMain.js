"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var react_1 = tslib_1.__importStar(require("react"));
var react_dom_1 = require("react-dom");
var classnames_1 = tslib_1.__importDefault(require("classnames"));
var button_1 = require("../button");
var transition_1 = require("../transition");
var create_rocket_1 = require("../_util/create-rocket");
var get_overlay_root_1 = require("../_util/get-overlay-root");
var use_visible_transition_1 = require("../_util/use-visible-transition");
var call_both_1 = require("../_util/call-both");
var ModalMessage_1 = require("./ModalMessage");
var use_outside_click_1 = require("../_util/use-outside-click");
var config_context_1 = require("../_util/config-context");
var uuid_1 = require("../_util/uuid");
var modalStack = [];
// 容器们
var ModalBackDrop = create_rocket_1.createRocket("ModalBackDrop", "div.@{prefix}-backdrop");
var ModalHeader = create_rocket_1.createRocket("ModalHeader", "div.@{prefix}-dialog__header");
var ModalBody = create_rocket_1.createRocket("ModalBody", "div.@{prefix}-dialog__body");
var ModalFooter = create_rocket_1.createRocket("ModalFooter", "div.@{prefix}-dialog__footer", "div.@{prefix}-dialog__btnwrap");
/**
 * 模态对话框组件
 */
function Modal(_a) {
    var visible = _a.visible, caption = _a.caption, size = _a.size, onClose = _a.onClose, onExited = _a.onExited, disableEscape = _a.disableEscape, disableCloseIcon = _a.disableCloseIcon, maskClosable = _a.maskClosable, _b = _a.destroyOnClose, destroyOnClose = _b === void 0 ? true : _b, className = _a.className, style = _a.style, children = _a.children;
    var classPrefix = config_context_1.useConfig().classPrefix;
    var ref = react_1.useRef(null);
    var idRef = react_1.useRef(uuid_1.uuid());
    var dialogRef = react_1.useRef(null);
    var _c = use_outside_click_1.useOutsideClick(ref), listen = _c.listen, ignoreProps = _c.ignoreProps;
    listen(function () { return maskClosable && visible && onClose(); });
    // 监听 ESC 键
    react_1.useEffect(function () {
        if (!visible) {
            return function () { return null; };
        }
        var handleKeydown = function (evt) {
            if (evt.keyCode === 27 &&
                !disableEscape &&
                modalStack[modalStack.length - 1] === idRef.current &&
                onClose) {
                onClose();
            }
        };
        window.addEventListener("keydown", handleKeydown);
        return function () { return window.removeEventListener("keydown", handleKeydown); };
    }, [visible, disableEscape, onClose]);
    var _d = use_visible_transition_1.useVisibleTransition(visible), contentIn = _d.contentIn, shouldContentEnter = _d.shouldContentEnter, shouldContentRender = _d.shouldContentRender, onContentExit = _d.onContentExit;
    react_1.useEffect(function () {
        var id = idRef.current;
        // 等待动画及全部 esc 事件触发完毕
        setTimeout(function () {
            if (visible) {
                modalStack.push(id);
            }
            else {
                modalStack = modalStack.filter(function (i) { return i !== id; });
            }
        }, 100);
    }, [visible]);
    if (!shouldContentRender && destroyOnClose) {
        return null;
    }
    // 有标题，或者有图标，就需要渲染 header
    var hasHeader = Boolean(caption) || !disableCloseIcon;
    // 内置尺寸名称
    var sizeClassName = null;
    if (typeof size === "string" && ["s", "l", "xl", "auto"].indexOf(size) > -1) {
        sizeClassName = "size-" + size;
    }
    var dialog = (react_1.default.createElement("div", { className: classPrefix + "-overlay " + classPrefix + "-dialog-parent", style: {
            display: !destroyOnClose && !contentIn ? "none" : undefined,
        } },
        react_1.default.createElement(transition_1.FadeTransition, { in: shouldContentEnter, opacity: 0.5 },
            react_1.default.createElement(ModalBackDrop, null)),
        react_1.default.createElement(transition_1.SlideTransition, { unmountOnExit: destroyOnClose, in: shouldContentEnter, onExited: call_both_1.callBoth(onExited, onContentExit) },
            react_1.default.createElement("div", { className: classnames_1.default(classPrefix + "-dialog", className), style: style, onClick: function (e) { return e.stopPropagation(); } },
                react_1.default.createElement("div", tslib_1.__assign({ ref: ref, className: classnames_1.default(classPrefix + "-dialog__inner", sizeClassName), style: size > 0 || /%$/.test(String(size)) ? { width: size } : null }, ignoreProps),
                    hasHeader && (react_1.default.createElement(ModalHeader, null,
                        caption && (react_1.default.createElement("h3", { className: classPrefix + "-dialog__headertitle" }, caption)),
                        !disableCloseIcon && react_1.default.createElement(button_1.Button, { icon: "close", onClick: onClose }))),
                    children)))));
    return react_dom_1.createPortal(dialog, get_overlay_root_1.getOverlayRoot());
}
exports.Modal = Modal;
/**
 * 渲染对话框的主要内容
 */
Modal.Body = ModalBody;
/**
 * 渲染对话框的底部内容
 */
Modal.Footer = ModalFooter;
/**
 * 对话框消息内容，可置于 Modal.Body 中
 */
Modal.Message = ModalMessage_1.ModalMessage;
//# sourceMappingURL=ModalMain.js.map