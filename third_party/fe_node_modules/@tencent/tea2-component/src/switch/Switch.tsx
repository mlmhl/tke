import React, { useContext } from "react";
import classNames from "classnames";
import { Omit } from "../_type";
import { CheckProps, CheckContext } from "../check";
import { Text } from "../text";
import { useDefaultValue } from "../form/controlled";
import { callBoth } from "../_util/call-both";
import { Tooltip } from "../tooltip";
import { useConfig } from "../_util/config-context";

/**
 * Switch 组件所接收的参数
 */
export interface SwitchProps extends Omit<CheckProps, "type"> {
  /**
   * 是否繁忙
   */
  loading?: boolean;
}

const noop = () => {};

export function Switch(props: SwitchProps) {
  const { classPrefix } = useConfig();
  // 支持从 Context 注入
  const context = useContext(CheckContext);

  if (context) {
    const checkProps = context.inject({ type: "checkbox", ...props });
    delete checkProps.type;
    // eslint-disable-next-line no-param-reassign
    props = checkProps;
  }

  const {
    name,
    value,
    disabled,
    onChange = noop,
    onClick,
    loading,
    tooltip,
    children,
    className,
    ...extraProps
  } = useDefaultValue(props, false);

  let component = (
    <label
      className={classNames(
        `${classPrefix}-switch`,
        { "is-loading": loading },
        className
      )}
      {...(children ? {} : extraProps)}
    >
      <input
        readOnly
        type="checkbox"
        className={`${classPrefix}-switch__input`}
        checked={value}
        disabled={disabled}
        onClick={callBoth(
          onClick,
          (event: React.MouseEvent<HTMLInputElement>) => {
            const { checked } = event.currentTarget;
            onChange(checked, {
              event,
              check: {
                type: "checkbox",
                ...props,
                value: checked,
              },
            });
          }
        )}
      />
      <span className={`${classPrefix}-switch__toggle`} />
    </label>
  );

  // 默认是不需要 children 的，如果提供了，需要包装一层
  if (children) {
    component = (
      <label
        onClick={onClick}
        style={{ cursor: disabled ? "default" : "pointer" }}
        {...extraProps}
      >
        {component}
        <Text reset style={{ verticalAlign: "middle", margin: "0 5px" }}>
          {children}
        </Text>
      </label>
    );
  }

  if (tooltip) {
    component = <Tooltip title={tooltip}>{component}</Tooltip>;
  }

  return component;
}
